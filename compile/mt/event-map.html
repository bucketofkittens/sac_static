<div id="events-map-container">
    <div id="events-map" class="events-map"></div>
    <div id="events-map-toner" class="events-map-toner"></div>
</div>
<script type="text/javascript">

    var trucks = [
        {
            index: 0,
            type: 'good',
            position: {top: 460, left: 840},
            toolTipDir: 'bottom',
            time: '18.02 15:32',
            number: 'О 777 НО 62',
            status: 'Оплачено',
        },
        {
            index: 1,
            type: 'bad',
            position: {top: 320, left: 475},
            toolTipDir: 'top',
            time: '18.02 15:32',
            number: 'Е 111 КХ 95',
            status: 'Несоответствие НЗ',
        },
        {
            index: 2,
            type: 'good',
            position: {top: 392, left: 750},
            toolTipDir: 'bottom',
            time: '23.02 15:32',
            number: 'A 807 ЕК 28',
            status: 'Оплачено',
        },
    ];


    var ramps = [
        {
            index: 0,
            position: {top: 485, left: 810},
            angle: 115, // Degrees
            number: 'M9-001',
            positionName: '41-й км трассы M9',
            positionСoords: '55°48’36   37°26’33',
        },
        {
            index: 1,
            position: {top: 500, left: 775},
            angle: 10, // Degrees
            number: 'M9-002',
            positionName: '43-й км трассы M9',
            positionСoords: '55°48’36   37°26’33',
        },
        {
            index: 2,
            position: {top: 460, left: 765},
            angle: -25, // Degrees
            number: 'M9-003',
            positionName: '46-й км трассы M9',
            positionСoords: '55°48’36   37°26’33',
        },
        {
            index: 4,
            position: {top: 375, left: 550},
            angle: 65, // Degrees
            number: 'M9-005',
            positionName: '87-й км трассы M9',
            positionСoords: '55°48’36   37°26’33',
        },
        {
            index: 3,
            position: {top: 365, left: 515},
            angle: -35, // Degrees
            number: 'M9-004',
            positionName: '84-й км трассы M9',
            positionСoords: '55°48’36   37°26’33',
        },
    ];
    var mapTag;


    $(function () {

        mapTag = $('#events-map');
        // Add trucks to the map
        _.each(trucks, function (truck) {
            var truckMark = $('<div class="placemark truck">');
            truckMark.attr('data-index', truck.index);
            truckMark.addClass(truck.type);
            truckMark.css({left: truck.position.left, top: truck.position.top});
            mapTag.append(truckMark);
        });
        mapTag.on('click', '.truck.placemark', truckMenu );

        // Add ramps to the map
        _.each(ramps, function (ramp) {
            var rampMark = $('<div class="ramp">');
            rampMark.attr('data-index', ramp.index);
            rampMark.css({left: ramp.position.left, top: ramp.position.top});
            rampMark.css({transform: 'rotate('+ramp.angle+'deg)'});
            mapTag.append(rampMark);
        });
        mapTag.on('click', '.ramp', rampMenu);
    });

    function truckMenu (e) {
        var index = parseInt(this.getAttribute('data-index'));
        var truck = trucks[index];
        if (truck.tooltip) {
            truck.tooltip.toggle();
        } else {
            console.log('Truck menu is invoked on', this);
            var menu = new EventMapTruckMenuWidget({
                container: $('#events-map'),
                index: truck.index,
                target: this,
                class: 'event-truck-menu',
                side: truck.toolTipDir,
                color: (truck.type == 'bad') ? 'red' : 'blue',
            }, application.panels.SVP);
            menu.setContent('<div class="center">' +
                '<p class="time">'+truck.time+'</p>' +
                '<p class="gosnumber">'+truck.number+'</p>' +
                '<p class="truck-status">'+truck.status+'</p>' +
            '</div>');
            menu.show();
            truck.tooltip = menu;
        }
    }

    function rampMenu (e) {
        var index = parseInt(this.getAttribute('data-index'));
        var ramp = ramps[index];
        if (ramp.tooltip) {
            ramp.tooltip.toggle();
        } else {
            console.log('Ramp menu is invoked on', this);
            var menu = new EventMapRampMenuWidget({
                container: $('#events-map'),
                index: ramp.index,
                target: this,
                class: 'event-ramp-menu',
                side: 'bottom',
                color: 'blue',
            }, ramp, application.panels.SVP);
            menu.setContent('<div class="center">' +
                    '<p class="gosnumber">'+ramp.number+'</p>' +
                    '<p>Журнал</p>' +
                    '</div>');
            menu.show();
            ramp.tooltip = menu;
        }
    }

</script>
